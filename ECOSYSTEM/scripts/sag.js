(()=>{(function(){"use strict";let f="sag.state",h={enc:function(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},dec:function(e){return atob((e||"").replace(/-/g,"+").replace(/_/g,"/"))}};function o(){return Date.now()}function g(e){try{return JSON.parse(e)}catch{return null}}function O(){let e=new URLSearchParams(location.search).get("sag");if(!e)return null;let t=h.dec(e);return g(t)}function v(){try{return g(localStorage.getItem(f))}catch{return null}}function d(e){try{localStorage.setItem(f,JSON.stringify(e))}catch{}}function x(){try{localStorage.removeItem(f)}catch{}}function m(e){return e&&e.exp&&o()>e.exp}function _(e){let t=[],n=Object.create(null);for(let r=0;r<(e||[]).length;r++){let i=e[r];if(i==null)continue;let l=typeof i=="string"?i:JSON.stringify(i);n[l]||(n[l]=1,t.push(i))}return t}function p(e,t){return e?t?{v:t.v|0||e.v|0||1,sid:t.sid||e.sid,t:o(),step:t.step!=null?t.step:e.step,flags:_([].concat(e.flags||[],t.flags||[])).slice(0,256),inv:Object.assign({},e.inv||{},t.inv||{}),src:t.src||e.src,exp:t.exp||e.exp,nonce:t.nonce||e.nonce||Math.random().toString(36).slice(2)}:Object.assign({},e,{t:o()}):Object.assign({},t,{t:o()})}function c(e){return e=e||{},{v:e.v|0||1,sid:e.sid||(self.crypto&&crypto.randomUUID?crypto.randomUUID():"sess_"+Math.random().toString(36).slice(2)),t:e.t||o(),step:e.step||null,flags:Array.isArray(e.flags)?e.flags.slice(0,256):[],inv:typeof e.inv=="object"&&e.inv?e.inv:{},src:e.src||location.host,exp:e.exp&&+e.exp||void 0,nonce:e.nonce||Math.random().toString(36).slice(2)}}function a(){let e=O(),t=v(),n=null;return e&&!m(e)?n=t?p(c(t),c(e)):c(e):t&&!m(t)?n=c(t):n=c({}),d(n),n}function j(e){return h.enc(JSON.stringify(e))}function y(e,t){t=t||{};let n=p(a(),c(t));d(n);let r=new URL(e,location.href);return r.searchParams.set("sag",j(n)),r.toString()}function w(e){let t=p(a(),c(e||{}));return d(t),t}function E(){return v()||a()}function U(){x()}function S(e){e=e||document;let t=e.querySelectorAll("a[data-sag], a.sag-link");for(let n=0;n<t.length;n++)(function(r){r.__sagEnhanced||(r.__sagEnhanced=!0,r.addEventListener("click",function(i){try{let l=r.getAttribute("data-flags"),A=r.getAttribute("data-inv"),L=r.getAttribute("data-step"),s={};if(L&&(s.step=L),l&&(s.flags=l.split(",").map(function(u){return u.trim()}).filter(Boolean)),A){let u=g(A);u&&typeof u=="object"&&(s.inv=u)}r.href=y(r.href,s)}catch{}},{capture:!0}))})(t[n])}function I(e){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}I(function(){a(),S(document)}),window.SAG={load:a,get:E,set:w,clear:U,href:y,enhance:S,version:"1.0"}})();})();
